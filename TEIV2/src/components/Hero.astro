---
import { Image } from 'astro:assets';
import Section from './Section.astro';
import 'swiper/css/bundle';

import slide1 from '../assets/hero-carousel/slide1.jpg';
import slide2 from '../assets/hero-carousel/slide2.jpg';
import slide3 from '../assets/hero-carousel/slide3.jpg';

interface Props {
  separator?: 'none' | 'curve-up' | 'curve-down';
}

const { separator = 'none' } = Astro.props as Props;

const slides = [
  {
    image: slide1,
    alt: 'Solar Panel Installation',
    text: 'Solar Panel & Battery Storage Solutions',
    subtext: 'Reduce bills, store energy, and make the most of your solar generation.',
    buttonText: 'Learn More',
    buttonLink: '/services/solar',
  },
  {
    image: slide2,
    alt: 'EV Charging Point',
    text: 'EV Charging Point Installations',
    subtext: 'Home and business charging points installed safely and professionally.',
    buttonText: 'View Services',
    buttonLink: '/services/ev-charging',
  },
  {
    image: slide3,
    alt: 'Electrical Maintenance',
    text: '24 Hour Emergency Callout',
    subtext: 'Fast response when you need it most, day or night.',
    buttonText: 'Emergency Service',
    buttonLink: '/teiv2/emergency',
  },
];
---

<Section>
  <div class="carousel-container">
    <div class="hero-swiper swiper">
      <div class="swiper-wrapper">
        {
          slides.map((slide, index) => (
            <div class="swiper-slide">
              <Image
                src={slide.image}
                alt={slide.alt}
                class="slide-image"
                loading={index === 0 ? "eager" : "lazy"}
                decoding="async"
                fetchpriority={index === 0 ? "high" : "auto"}
                widths={[640, 768, 1024, 1280, 1920, 2560]}
                sizes="100vw"
              />

              <div class="carousel-caption">
                <h2>{slide.text}</h2>
                <p class="carousel-subtext">{slide.subtext}</p>
                <a href={slide.buttonLink} class="slide-btn">{slide.buttonText}</a>
              </div>
            </div>
          ))
        }
      </div>

      <div class="swiper-pagination"></div>
      <div class="swiper-button swiper-button-prev" aria-label="Previous slide"></div>
      <div class="swiper-button swiper-button-next" aria-label="Next slide"></div>
    </div>
  </div>
</Section>

<style>

  .carousel-container {
    position: relative;
    width: 100%;
    height: calc(100vh - 60px);
    max-height: 520px;
    overflow: hidden;
    border-bottom: 4px solid var(--brand-yellow);
  }

  .hero-swiper {
    width: 100%;
    height: 100%;
  }

  .swiper-slide {
    position: relative;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* Show first slide immediately before Swiper loads */
  .swiper-slide:first-child {
    opacity: 1;
  }

  /* After Swiper initializes, show active slides */
  .swiper-initialized .swiper-slide {
    opacity: 0;
  }

  .swiper-initialized .swiper-slide-active {
    opacity: 1;
  }

  .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Controls */
  .hero-swiper :global(.swiper-button-prev),
  .hero-swiper :global(.swiper-button-next),
  .hero-swiper :global(.swiper-pagination) {
    z-index: 5;
  }

  .hero-swiper :global(.swiper-button-prev),
  .hero-swiper :global(.swiper-button-next) {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    color: var(--color-accent);
    background: rgba(0, 0, 0, 0.6);
    border: var(--color-primary)
    backdrop-filter: blur(4px);
    top: 65%;
    transform: translateY(-50%);
    transition: all 0.3s ease;
  }

  .hero-swiper :global(.swiper-button-prev):hover,
  .hero-swiper :global(.swiper-button-next):hover {
    background: var(--color-accent);
    color: var(--brand-black);
    border-color: var(--color-);
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 4px 16px rgba(253, 238, 33, 0.4);
  }

/* If you are using Swiperâ€™s navigation SVG icons */
.hero-swiper :global(.swiper-button-next .swiper-navigation-icon),
.hero-swiper :global(.swiper-button-prev .swiper-navigation-icon) {
  width: 18px;
  height: 18px;
  fill: #fdee21;
}

/* Fallback for default Swiper arrows (pseudo-element) */
.hero-swiper :global(.swiper-button-next)::after,
.hero-swiper :global(.swiper-button-prev)::after {
  font-size: 18px;
  color: #fdee21;
}

  .hero-swiper :global(.swiper-pagination) {
    left: 50%;
    transform: translateX(-50%);
    bottom: 9% !important;

    display: flex;
    align-items: center;
    width: auto;

    padding: 0.5rem 0.75rem;
    border-radius: 50px;

    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  .hero-swiper :global(.swiper-pagination-bullet) {
    width: 10px;
    height: 10px;
    border-radius: 50%;

    opacity: 1;
    background: rgba(255, 255, 255, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .hero-swiper :global(.swiper-pagination-bullet):hover {
    background: rgba(255, 255, 255, 0.75);
    transform: scale(1.2);
  }

  .hero-swiper :global(.swiper-pagination-bullet-active) {
    background: var(--color-accent);
    border-color: rgba(253, 238, 33, 0.5);
    transform: scale(1.3);
    box-shadow: 0 0 8px rgba(253, 238, 33, 0.6);
  }

  /* Caption */
  .carousel-caption {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 25%;

    background: linear-gradient(
      135deg,
      rgba(42, 145, 52, 0.92),
      rgba(31, 115, 40, 0.96)
    );

    padding: 1.5rem 2.5rem;
    border-radius: 24px;
    min-width: 340px;
    max-width: 90%;
    text-align: center;

    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
    border: solid 2px var(--color-accent);
    backdrop-filter: blur(6px);
  }

  .carousel-caption h2 {
    margin: 0 0 0.5rem;
    font-size: 2rem;
    font-weight: 900;
    color: var(--color-accent);
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    letter-spacing: 0.3px;
    line-height: 1.2;
  }

  .carousel-subtext {
    margin: 0 0 1.1rem;
    font-size: 1.05rem;
    line-height: 1.5;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    font-weight: 600;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .slide-btn {
    display: inline-block;
    background: var(--color-accent);
    color: var(--brand-black);
    padding: 0.85rem 2rem;
    border-radius: 50px;
    font-weight: 900;
    text-decoration: none;
    font-size: 1.05rem;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(253, 238, 33, 0.4);
    position: relative;
    overflow: hidden;
    letter-spacing: 0.3px;
  }

  .slide-btn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .slide-btn:hover::before {
    transform: translateX(0);
  }

  .slide-btn:hover {
    background: var(--brand-black);
    color: var(--color-accent);
    border-color: var(--color-accent);
    transform: translateY(-3px);
    box-shadow: 0 6px 24px rgba(253, 238, 33, 0.5);
  }

  .slide-btn:focus-visible {
    outline: 3px solid var(--color-accent);
    outline-offset: 3px;
  }

  @media (max-width: 768px) {
    .carousel-container {
      max-height: 500px;
    }

    .carousel-caption {
      top: 35%;
      bottom: auto;
      padding: 1.2rem 1.75rem;
      min-width: 280px;
      border-radius: 20px;
    }

    .carousel-caption h2 {
      font-size: 1.5rem;
    }

    .carousel-subtext {
      font-size: 0.95rem;
      margin-bottom: 0.95rem;
    }

    .slide-btn {
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
    }

    .hero-swiper :global(.swiper-button-prev),
    .hero-swiper :global(.swiper-button-next) {
      width: 40px;
      height: 40px;
    }

    .hero-swiper :global(.swiper-pagination-bullet) {
      width: 9px;
      height: 9px;
    }
  }

  @media (max-width: 480px) {
    .carousel-caption {
      bottom: 25%;
      top: auto;
      padding: 1rem 1.25rem;
      border-radius: 18px;
    }

    .carousel-caption h2 {
      font-size: 1.25rem;
    }

    .carousel-subtext {
      font-size: 0.9rem;
      margin-bottom: 0.85rem;
    }

    .slide-btn {
      font-size: 0.9rem;
      padding: 0.65rem 1.25rem;
    }

    .hero-swiper :global(.swiper-button-prev),
    .hero-swiper :global(.swiper-button-next) {
      width: 36px;
      height: 36px;
    }

    .hero-swiper :global(.swiper-pagination) {
      bottom: 7% !important;
      padding: 0.4rem 0.6rem;
    }

    .hero-swiper :global(.swiper-pagination-bullet) {
      width: 8px;
      height: 8px;
    }
  }

  
</style>

<script>
  let swiper: any = null;
  let swiperInitialized = false;

  const preloadNext = (n: number): void => {
    if (!swiper || !swiper.slides) return;
    const slides = Array.from(swiper.slides) as Element[];
    slides
      .slice(swiper.activeIndex, swiper.activeIndex + n + 1)
      .forEach((slide: Element) => {
        const img = slide.querySelector('img') as HTMLImageElement | null;
        if (img) img.setAttribute('loading', 'eager');
      });
  };

  const initHeroSwiper = async () => {
    const root = document.querySelector('.hero-swiper');
    if (!(root instanceof HTMLElement)) return;

    if (root.dataset.swiperInit === 'true') return;
    root.dataset.swiperInit = 'true';
    swiperInitialized = true;

    const paginationEl = root.querySelector('.swiper-pagination');
    const nextEl = root.querySelector('.swiper-button-next');
    const prevEl = root.querySelector('.swiper-button-prev');

    if (!(paginationEl instanceof HTMLElement)) return;
    if (!(nextEl instanceof HTMLElement)) return;
    if (!(prevEl instanceof HTMLElement)) return;

    // Dynamically import Swiper only when needed
    const [{ default: Swiper }, { Navigation, Pagination, Autoplay }] = await Promise.all([
      import('swiper'),
      import('swiper/modules')
    ]);

    swiper = new Swiper(root, {
      modules: [Navigation, Pagination, Autoplay],
      loop: true,
      autoplay: { delay: 5000, disableOnInteraction: false },
      pagination: { el: paginationEl, clickable: true },
      navigation: { nextEl, prevEl },
      speed: 600,
    });

    swiper.on('slideChange', () => preloadNext(2));
    preloadNext(2);
  };

  // Only load Swiper after user interaction or long idle
  document.addEventListener('astro:page-load', () => {
    if (swiperInitialized) return;
    // Wait 3 seconds then load if not interactive
    setTimeout(() => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => initHeroSwiper());
      } else {
        initHeroSwiper();
      }
    }, 3000);
  });

  // Preload on interaction
  document.addEventListener('click', () => {
    if (!swiperInitialized) initHeroSwiper();
  }, { once: true });
</script>
